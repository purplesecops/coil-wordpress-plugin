version: 2.0
orbs:
  cypress: cypress-io/cypress@1.28.0
jobs:
  js_scss_linting:
    docker:
      - image: cimg/node:14.10.1
    steps:
      - checkout
      - run: npm install
      - run: npx grunt test
  php_testing:
    docker:
      - image: cimg/php:7.4.19
      - image: circleci/mysql:8.0.16
        environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          MYSQL_USER: root
          MYSQL_ROOT_PASSWORD: "root"
          MYSQL_DATABASE: wordpress_test
    working_directory: ~/php
    steps:
      - checkout
      - restore_cache:
          key: -v1-deps{{checksum "composer.lock"}}
      - run: composer install
      - save_cache:
          key: -v1-deps{{checksum "composer.lock"}}
          paths:
            - vendor
      - run:
          # The primary container isn't MYSQL, running a sleep command until it's ready.
          name: Waiting for MySQL to be ready
          command: |
            for i in `seq 1 10`;
            do
              nc -z 127.0.0.1 3306 && echo Success && exit 0
              echo -n .
              sleep 1
            done
            echo Failed waiting for MySQL && exit 1
      - run:
          name: Install MySQL CLI
          command: |
            sudo apt update
            sudo apt-get install mysql-client
      - run:
          name: Setup PHPUnit
          command: sudo bash ./scripts/setup-phpunit-ci.sh
      - run:
          name: Functional PHPUnit tests
          command: ./vendor/bin/phpunit
      - run:
          name: PHP linting
          command: composer phpcs
  cypress_tests:
    docker:
      - image: php:7-apache
      - image: mysql
        environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          MYSQL_USER: admin
          MYSQL_PASSWORD: "password"
          MYSQL_ROOT_PASSWORD: "password"
          MYSQL_DATABASE: wordpress
          # Might need to be in quotes?? Or localhost
          MYSQL_HOST: 127.0.0.1
    working_directory: /var/www/html
    steps:
      - checkout
      - run: mkdir /var/www/html/coil-wordpress-plugin && mv * /var/www/html/coil-wordpress-plugin
      - run:
        # Might also need wp-core-download becasue code only includes plugin not WordPress site, still need to activate plugin first
          name: Install extensions
          command: |
            docker-php-ext-install mysqli
            docker-php-ext-install pdo pdo_mysql
      - run:
          name: Installing wp-cli.phar
          command: |
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
      - run:
          name: Installing WordPress
          command: |
              apt update
              apt install -y libzip-dev zip && docker-php-ext-install zip
              wp core download --allow-root
              mv /var/www/html/coil-wordpress-plugin /var/www/html/wp-content/plugins/coil-wordpress-plugin
      - run:
          name: Adjusting the wp-config.php file appropriately for the context
          command: |
            cp wp-config-sample.php wp-config.php
            sed -i "s/database_name_here/wordpress/" "wp-config.php"
            sed -i "s/username_here/admin/" "wp-config.php"
            sed -i "s/password_here/password/" "wp-config.php"
            sed -i "s/localhost/127.0.0.1/" "wp-config.php"
      - run:
          name: Installing nvm to install Cypress as well as its dependencies
          command: |
            apt install libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb -y
            curl -o install.sh https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh
            bash install.sh
            chmod -R 777 ~
            source ~/.nvm/nvm.sh && nvm install 12 && nvm use 12 && pwd && ls -la && nvm install-latest-npm && npm install cypress
      - run:
          name: Running apache
          command: |
            pwd && ls
            cd /var/www/html/wp-content/plugins/coil-wordpress-plugin
            pwd && ls
            cd /var/www/html/wp-content/plugins/coil-wordpress-plugin/scripts
            pwd && ls
            cd /var/www/html
            bash /var/www/html/wp-content/plugins/coil-wordpress-plugin/scripts/apache2-background.sh
      - run:
          name: Initializing the database, importing data, and activating the plugin
          command: |
            wp core install --url=http://php --title=wordpress --admin_user=admin --admin_password=password --admin_email=admin@example.com --skip-email --allow-root
            wp db import /var/www/html/wp-content/plugins/coil-wordpress-plugin/scripts/test-site.sql --allow-root
            wp plugin activate coil-wordpress-plugin --allow-root
      - run:
          name: Cypress tests
          command: |
            cd /var/www/html/wp-content/plugins/coil-wordpress-plugin
            npx cypress run --config baseUrl="http://127.0.0.1"
workflows:
  version: 2
  test:
    jobs:
      # - js_scss_linting
      # - php_testing:
      #     requires:
      #       - js_scss_linting
      - cypress_tests
          # requires:
            # - php_testing
